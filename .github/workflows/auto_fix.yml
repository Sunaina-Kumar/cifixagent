name: CI Fix Agent

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  issue_comment:
    types: [created]

jobs:
  propose:
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      actions: read
      pull-requests: write
      contents: read
    steps:
      - name: Checkout failed commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Export Python version
        run: echo "PYTHON_VERSION=$(python -V | awk '{print $2}')" >> $GITHUB_ENV

      - name: Install agent deps
        run: pip install requests

      - name: Run agent (propose)
        env:
          GITHUB_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          CI_JANITOR_APPROVED: "0"
        run: python agent.py

  apply:
    if: ${{ github.event_name == 'issue_comment' &&
            github.event.issue.pull_request &&
            (contains(github.event.comment.body, '/ci-janitor approve')) }}
    runs-on: ubuntu-latest
    permissions:
      actions: read
      pull-requests: write
      contents: write
    steps:
      - name: Get PR info
        id: pr
        env:
          GITHUB_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          api="https://api.github.com/repos/${REPO}/pulls/${PR_NUMBER}"
          json=$(curl -sS -H "Authorization: Bearer ${GITHUB_TOKEN}" "$api")
          echo "head_ref=$(echo "$json" | python -c "import sys,json; print(json.load(sys.stdin)['head']['ref'])")" >> $GITHUB_OUTPUT
          echo "head_repo=$(echo "$json" | python -c "import sys,json; print(json.load(sys.stdin)['head']['repo']['full_name'])")" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr.outputs.head_repo }}
          ref: ${{ steps.pr.outputs.head_ref }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Export Python version
        run: echo "PYTHON_VERSION=$(python -V | awk '{print $2}')" >> $GITHUB_ENV

      - name: Install agent deps
        run: pip install requests

      - name: Run agent (apply)
        env:
          GITHUB_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.issue.number }}
          PR_BRANCH: ${{ steps.pr.outputs.head_ref }}
          CI_JANITOR_APPROVED: "1"
        run: python agent.py
